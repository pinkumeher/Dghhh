<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iron Man Repulsor HUD</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Courier New', Courier, monospace; }
        canvas { display: block; }
        
        /* JARVIS UI STYLE */
        #ui-container {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #00ffff;
            pointer-events: none;
            background: rgba(0, 20, 40, 0.7);
            padding: 20px;
            border: 1px solid #00ffff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            width: 250px;
        }
        
        h1 { margin: 0; font-size: 1.2rem; text-transform: uppercase; color: #ff3333; text-shadow: 0 0 5px #ff0000; }
        h2 { margin: 5px 0 15px 0; font-size: 0.8rem; color: #d4af37; text-transform: uppercase; letter-spacing: 2px; }

        .hud-line { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.8rem; }
        .hud-val { font-weight: bold; color: #fff; }

        #webcam-feed {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            transform: scaleX(-1);
            border: 2px solid #d4af37; /* Gold Border */
            border-radius: 10px;
            opacity: 0.8;
            filter: sepia(100%) hue-rotate(180deg) saturate(200%); /* Jarvis Blue Filter */
        }
        
        .scan-line {
            width: 100%; height: 2px; background: #00ffff;
            position: absolute; top: 0; left: 0;
            animation: scan 2s infinite linear;
            opacity: 0.5;
        }
        @keyframes scan { 0% {top:0;} 100% {top:100%;} }

        .instruction { color: #d4af37; font-weight: bold; }
    </style>
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="ui-container">
        <h1>MARK LXXXV</h1>
        <h2>Repulsor System</h2>
        <div class="scan-line"></div>
        
        <div class="hud-line">
            <span>SYSTEM:</span> <span class="hud-val">ONLINE</span>
        </div>
        <div class="hud-line">
            <span>ARMOR:</span> <span class="hud-val" style="color:#d4af37">NANO-TECH</span>
        </div>
        <div class="hud-line">
            <span>CORE:</span> <span class="hud-val" style="color:#00ffff">STABLE</span>
        </div>
        
        <hr style="border-color: #005555; margin: 10px 0;">
        
        <p>üëã Move Hand to Aim</p>
        <p>ü§è <span class="instruction">Pinch</span> to Lock Armor</p>
        <p>üñê <span class="instruction">Open</span> to Power Up</p>
    </div>

    <video id="webcam-feed" autoplay playsinline></video>

<script>
    // --- CONFIGURATION ---
    const PARTICLE_COUNT = 30000; // High density for armor plating
    const PARTICLE_SIZE = 0.08;
    const SMOOTHING = 0.08; 

    // --- THREE.JS SETUP ---
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x050505, 0.02); // Dark background

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 16;

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    // --- PARTICLES ---
    const geometry = new THREE.BufferGeometry();
    const positions = new Float32Array(PARTICLE_COUNT * 3);
    const colors = new Float32Array(PARTICLE_COUNT * 3);
    const targetPositions = new Float32Array(PARTICLE_COUNT * 3);

    // Initialize Particles randomly
    for (let i = 0; i < PARTICLE_COUNT * 3; i++) {
        positions[i] = (Math.random() - 0.5) * 50;
        targetPositions[i] = positions[i];
    }

    // Material with Vertex Colors
    const material = new THREE.PointsMaterial({
        size: PARTICLE_SIZE,
        vertexColors: true,
        blending: THREE.AdditiveBlending, // Glow effect
        depthWrite: false,
        transparent: true,
        opacity: 0.9
    });

    const particleSystem = new THREE.Points(geometry, material);
    scene.add(particleSystem);

    // ==========================================
    //       IRON MAN HAND MODEL LOGIC
    // ==========================================
    
    function generateIronManHand() {
        const c = geometry.attributes.color;

        for (let i = 0; i < PARTICLE_COUNT; i++) {
            const r = Math.random();
            let x, y, z;
            let colR, colG, colB;

            // --- 1. THE REPULSOR (ARC REACTOR) - 15% ---
            // A glowing circle in the center of the palm
            if (r < 0.15) {
                const angle = Math.random() * Math.PI * 2;
                // Density gradient: more particles in center
                const radius = Math.random() * 1.4; 
                
                x = Math.cos(angle) * radius;
                y = Math.sin(angle) * radius;
                z = 0.5 + Math.random() * 0.5; // Slightly protruding

                // Color: ARC REACTOR BLUE / WHITE
                colR = 0.5; colG = 0.9; colB = 1.0; 
                
                // Make the very center pure white
                if(radius < 0.5) { colR=1.0; colG=1.0; colB=1.0; }
            } 
            
            // --- 2. THE PALM (ARMOR PLATE) - 35% ---
            else if (r < 0.50) {
                // Flattened box behind repulsor
                x = (Math.random() - 0.5) * 5.0;
                y = (Math.random() - 0.5) * 5.5;
                z = -0.5 - (Math.random() * 1.5);

                // Cut out the circle for the repulsor
                const dist = Math.sqrt(x*x + y*y);
                if(dist < 1.4) {
                    // Push these particles to the edge (Rim of repulsor)
                    const angle = Math.atan2(y, x);
                    x = Math.cos(angle) * 1.5;
                    y = Math.sin(angle) * 1.5;
                    colR = 0.8; colG = 0.6; colB = 0.0; // Gold Rim
                } else {
                    // Armor Color: Hot Rod Red or Gold
                    if (Math.random() > 0.3) {
                        colR = 0.8; colG = 0.1; colB = 0.1; // Red
                    } else {
                        colR = 1.0; colG = 0.8; colB = 0.1; // Gold
                    }
                }
            } 

            // --- 3. THE FINGERS - 50% ---
            else {
                const fingerIdx = Math.floor(Math.random() * 5);
                const seg = Math.random(); 
                
                // Finger Setup
                if (fingerIdx === 0) { 
                    // THUMB (Angled)
                    x = -3.2 - (seg * 2.5);
                    y = -1.5 + (seg * 2.5);
                    z = 0;
                } else {
                    // FINGERS (Index to Pinky)
                    let xBase = 0; let len = 4.0; let yStart = 2.8;
                    
                    if (fingerIdx === 1) { xBase = -1.9; len = 4.2; } // Index
                    if (fingerIdx === 2) { xBase = 0.0;  len = 4.8; } // Middle
                    if (fingerIdx === 3) { xBase = 1.9;  len = 4.2; } // Ring
                    if (fingerIdx === 4) { xBase = 3.6;  len = 3.2; yStart=1.8; } // Pinky

                    x = xBase + (Math.random()-0.5)*0.6; // Width
                    y = yStart + (seg * len);
                    z = (seg*seg) * 2.0; // Curl
                }
                
                // Add depth to fingers
                z += (Math.random()-0.5)*0.8;

                // Finger Color: Mostly Gold for fingertips, Red for knuckles
                if (seg > 0.8) {
                    colR = 1.0; colG = 0.8; colB = 0.1; // Gold Tips
                } else {
                    colR = 0.8; colG = 0.1; colB = 0.1; // Red Base
                }
            }

            // Set Target
            targetPositions[i * 3] = x;
            targetPositions[i * 3 + 1] = y;
            targetPositions[i * 3 + 2] = z;

            // Set Color
            c.setXYZ(i, colR, colG, colB);
        }
        
        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geometry.setAttribute('color', c);
    }

    generateIronManHand();

    // ==========================================
    //           TRACKING & INTERACTION
    // ==========================================
    let pinchStrength = 0;
    let handX = 0, handY = 0;

    const videoElement = document.getElementById('webcam-feed');
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.6,
        minTrackingConfidence: 0.6
    });

    hands.onResults((results) => {
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const lm = results.multiHandLandmarks[0];
            
            // 1. Rotation Tracking
            handX += ((lm[8].x - 0.5) * 2 - handX) * 0.1;
            handY += (-(lm[8].y - 0.5) * 2 - handY) * 0.1;

            // 2. Pinch Strength (Thumb vs Index tip distance)
            const d = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
            // Map distance: 0.02 (closed) to 0.15 (open)
            pinchStrength = 1 - Math.min(Math.max(d / 0.15, 0), 1);
        }
    });

    const cameraUtils = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 320, height: 240
    });
    cameraUtils.start();

    // ==========================================
    //             ANIMATION LOOP
    // ==========================================
    const clock = new THREE.Clock();

    function animate() {
        requestAnimationFrame(animate);
        const time = clock.getElapsedTime();
        const pos = geometry.attributes.position.array;
        const col = geometry.attributes.color.array;

        // Interaction Transforms
        particleSystem.rotation.y = -handX * 2.0;
        particleSystem.rotation.x = handY * 2.0;

        // "Lock" Mechanics
        // If pinched (strength 1): Hand is solid, stable.
        // If open (strength 0): Repulsor vibrates/charges.
        const lockFactor = pinchStrength; 
        const vibration = (1 - pinchStrength) * 0.15; // Vibrate when open

        for (let i = 0; i < PARTICLE_COUNT; i++) {
            const ix = i * 3;
            
            let tx = targetPositions[ix];
            let ty = targetPositions[ix+1];
            let tz = targetPositions[ix+2];

            // Is this particle part of the REPULSOR? (Blue ones)
            // We identify blue particles by their Blue channel > 0.9
            const isRepulsor = (col[ix+2] > 0.9 && col[ix] < 0.6);

            if (isRepulsor) {
                // REPULSOR ANIMATION
                // Pulse outward
                const pulse = Math.sin(time * 10) * 0.2;
                tz += pulse; 

                // If Hand Open: Beam Effect (Stream forward)
                if (pinchStrength < 0.2) {
                     tz += Math.random() * 2.0; // Shoot forward
                     tx += (Math.random()-0.5) * 0.2; // Jitter
                     ty += (Math.random()-0.5) * 0.2;
                }
            } else {
                // ARMOR ANIMATION
                // Just slight breathing if open
                if (pinchStrength < 0.2) {
                    tx += (Math.random()-0.5) * vibration;
                    ty += (Math.random()-0.5) * vibration;
                    tz += (Math.random()-0.5) * vibration;
                }
            }

            // Move to target
            pos[ix] += (tx - pos[ix]) * SMOOTHING;
            pos[ix+1] += (ty - pos[ix+1]) * SMOOTHING;
            pos[ix+2] += (tz - pos[ix+2]) * SMOOTHING;
        }

        geometry.attributes.position.needsUpdate = true;
        renderer.render(scene, camera);
    }

    // Resize Handle
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    animate();
</script>
</body>
</html>
